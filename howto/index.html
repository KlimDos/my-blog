
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://blog.alimov.pro/howto/">
      
      
        <link rel="prev" href="../about-me/">
      
      
        <link rel="next" href="../postmortem-template/">
      
      
      <link rel="icon" href="../favicon.gif">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.45">
    
    
      
        <title>Spinning Up AWS EKS Nodes with Custom Kubelet Settings - Dev Oops ðŸ™Š</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spinning-up-aws-eks-nodes-with-custom-kubelet-settings" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Dev Oops ðŸ™Š" class="md-header__button md-logo" aria-label="Dev Oops ðŸ™Š" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Dev Oops ðŸ™Š
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spinning Up AWS EKS Nodes with Custom Kubelet Settings
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Dev Oops ðŸ™Š" class="md-nav__button md-logo" aria-label="Dev Oops ðŸ™Š" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Dev Oops ðŸ™Š
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog Focus Areas
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about-me/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About me
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Spinning Up AWS EKS Nodes with Custom Kubelet Settings
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Spinning Up AWS EKS Nodes with Custom Kubelet Settings
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-cause" class="md-nav__link">
    <span class="md-ellipsis">
      Root Cause
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-logging-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Logging Pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubelet-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Kubelet Settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-by-step-implementation-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Implementation with Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-a-template-file-for-generating-the-user-data" class="md-nav__link">
    <span class="md-ellipsis">
      Use a template file for generating the user data:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-data-template" class="md-nav__link">
    <span class="md-ellipsis">
      User Data Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-the-launch-template-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Define the launch template in Terraform:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after-deploying-the-eks-node-monitor-the-bootstrap-process-by-checking-the-logs" class="md-nav__link">
    <span class="md-ellipsis">
      After deploying the EKS node, monitor the bootstrap process by checking the logs:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../postmortem-template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Postmortem: [Incident Title]
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-cause" class="md-nav__link">
    <span class="md-ellipsis">
      Root Cause
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-logging-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Logging Pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubelet-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Kubelet Settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-by-step-implementation-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Implementation with Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-a-template-file-for-generating-the-user-data" class="md-nav__link">
    <span class="md-ellipsis">
      Use a template file for generating the user data:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-data-template" class="md-nav__link">
    <span class="md-ellipsis">
      User Data Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-the-launch-template-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Define the launch template in Terraform:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after-deploying-the-eks-node-monitor-the-bootstrap-process-by-checking-the-logs" class="md-nav__link">
    <span class="md-ellipsis">
      After deploying the EKS node, monitor the bootstrap process by checking the logs:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="spinning-up-aws-eks-nodes-with-custom-kubelet-settings">Spinning Up AWS EKS Nodes with Custom Kubelet Settings</h1>
<h2 id="problem">Problem</h2>
<p>My application generates a large volume of logs written to <code>stdout</code>. However, I noticed missing log entries when analyzing them in Kibana.</p>
<h3 id="root-cause">Root Cause</h3>
<ol>
<li>By default, the <code>stdout</code> and <code>stderr</code> output from Kubernetes pods is stored on the host node in the <code>/var/log/pods/</code> directory.</li>
<li>Kubernetes rotates these log files when they reach 10MB:</li>
<li>The original <code>0.log</code> file is renamed to <code>0.log.&lt;timestamp&gt;</code>.</li>
<li>The older <code>0.log.&lt;timestamp&gt;</code> files are compressed into <code>0.log.&lt;timestamp&gt;.gz</code>.</li>
<li>Fluent Bit (used as a log collector) reads only the active <code>0.log</code> file via a symlink. </li>
</ol>
<p>When logs are generated rapidly (&gt;3MB per second), Fluent Bit may not process them completely before rotation occurs. This results in missing logs in the analytical interface, such as Kibana.</p>
<h2 id="solution">Solution</h2>
<h3 id="understanding-the-logging-pipeline">Understanding the Logging Pipeline</h3>
<ul>
<li><strong>Default Runtime</strong>: EKS uses ContainerD as the default container runtime.</li>
<li><strong>Managed by Kubelet</strong>: The <code>kubelet</code> is responsible for configuring ContainerD behavior, including log management.</li>
<li><strong>Customization Options</strong>: You can adjust the kubeletâ€™s log rotation settings via <code>kubelet-config.json</code> or launch arguments.</li>
</ul>
<h3 id="customizing-kubelet-settings">Customizing Kubelet Settings</h3>
<p>To resolve the issue, you can increase the maximum log file size by customizing kubelet arguments. For EKS, this is achieved by creating an AWS Launch Template with customized User Data.</p>
<h3 id="step-by-step-implementation-with-terraform">Step-by-Step Implementation with Terraform</h3>
<h3 id="use-a-template-file-for-generating-the-user-data">Use a template file for generating the user data:</h3>
<pre><code class="language-hcl">data &quot;template_file&quot; &quot;launch_template_userdata&quot; {
  template = file(&quot;templates/userdata.sh.tpl&quot;)
}
</code></pre>
<h3 id="user-data-template">User Data Template</h3>
<pre><code class="language-bash">MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&quot;//&quot;

--//
Content-Type: text/x-shellscript; charset=&quot;us-ascii&quot;

#!/bin/bash
echo &quot;Start of UserData&quot;
set -ex
/etc/eks/bootstrap.sh ccp-k8s-sandbox \
    --kubelet-extra-args '--max-log-size=100M'

echo &quot;End of UserData&quot;

--//--

</code></pre>
<h3 id="define-the-launch-template-in-terraform">Define the launch template in Terraform:</h3>
<pre><code class="language-hcl">resource &quot;aws_launch_template&quot; &quot;worker&quot; {
  for_each = toset(var.launch_template_names[&quot;custom-kubelet-settings&quot;])
  key_name = var.key_name

  network_interfaces {
    security_groups = [&quot;sg1&quot;, &quot;sg2&quot;]
  }

  metadata_options {
    http_endpoint               = &quot;enabled&quot;
    http_tokens                 = &quot;required&quot;
    http_put_response_hop_limit = 2
  }

  block_device_mappings {
    device_name = &quot;/dev/xvda&quot;
    ebs {
      volume_size = var.volume_size
    }
  }

  user_data = base64encode(
    data.template_file.launch_template_userdata.rendered,
  )

  tag_specifications {
    resource_type = &quot;instance&quot;
    tags = merge(local.cluster_resource_tags, { extraTag = &quot;example&quot; })
  }

  tag_specifications {
    resource_type = &quot;volume&quot;
    tags = merge(local.cluster_resource_tags, { extraTag = &quot;example&quot; })
  }

  tags = merge(local.cluster_resource_tags, { extraTag = &quot;example&quot; })

  lifecycle {
    create_before_destroy = true
  }
}

</code></pre>
<h3 id="after-deploying-the-eks-node-monitor-the-bootstrap-process-by-checking-the-logs">After deploying the EKS node, monitor the bootstrap process by checking the logs:</h3>
<pre><code class="language-bash">cat /var/log/cloud-init-output.log

</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>By customizing kubelet settings via an AWS Launch Template, you can resolve log rotation issues in EKS, ensuring that Fluent Bit processes all logs effectively and no data is lost in Kibana.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../js/analytics.js"></script>
      
    
  </body>
</html>